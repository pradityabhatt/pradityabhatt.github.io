/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

//JSON OBJECT FOR LIBRARY DATABASE
var jsonObject = {
    "type": "FeatureCollection",
    "features": [{
            "type": "Feature",
            "properties": {
                "OBJECTID": 1,
                "NAME": "Ancaster Library",
                "BUILDING_SQ_FT": 7500,
                "HOLDINGS": 58884,
                "CIRCULATION": 247037,
                "RANKING": "-3",
                "RADIUS_KM": 2,
                "LONGITUDE": "-79.97666063140129",
                "LATITUDE": "43.22530917338574"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.97666416693158, 43.22531765536685]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 2,
                "NAME": "Barton Library",
                "BUILDING_SQ_FT": 6272,
                "HOLDINGS": 25027,
                "CIRCULATION": 69297,
                "RANKING": "-2",
                "RADIUS_KM": 1,
                "LONGITUDE": "-79.84121898138898",
                "LATITUDE": "43.258031699450754"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.84122247574874, 43.25804019327632]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 3,
                "NAME": "Binbrook Library",
                "BUILDING_SQ_FT": 3192,
                "HOLDINGS": 18858,
                "CIRCULATION": 46545,
                "RANKING": "-1",
                "RADIUS_KM": 10,
                "LONGITUDE": "-79.80342947213485",
                "LATITUDE": "43.12170437851469"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.80343294304178, 43.1217128502743]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 4,
                "NAME": "Carlisle Library",
                "BUILDING_SQ_FT": 2491,
                "HOLDINGS": 18434,
                "CIRCULATION": 45113,
                "RANKING": "-1",
                "RADIUS_KM": 10,
                "LONGITUDE": "-79.98108621096793",
                "LATITUDE": "43.39605338581425"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.98108976210511, 43.39606189789001]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 5,
                "NAME": "Concession Library",
                "BUILDING_SQ_FT": 8380,
                "HOLDINGS": 47689,
                "CIRCULATION": 173618,
                "RANKING": "-3",
                "RADIUS_KM": 2,
                "LONGITUDE": "-79.85136825154244",
                "LATITUDE": "43.24104159881205"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.8513717480789, 43.24105008957145]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 6,
                "NAME": "Dundas Library",
                "BUILDING_SQ_FT": 13712,
                "HOLDINGS": 86203,
                "CIRCULATION": 280443,
                "RANKING": "-3",
                "RADIUS_KM": 2,
                "LONGITUDE": "-79.95494871167945",
                "LATITUDE": "43.265483892235544"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.95495224354937, 43.26549238198659]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 7,
                "NAME": "Hamilton Central Library",
                "BUILDING_SQ_FT": 146131,
                "HOLDINGS": 146131,
                "CIRCULATION": 830909,
                "RANKING": "-5",
                "RADIUS_KM": 5,
                "LONGITUDE": "-79.87069971576268",
                "LATITUDE": "43.25894156065867"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.87070321981486, 43.25895005343457]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 8,
                "NAME": "Kenilworth Library",
                "BUILDING_SQ_FT": 8000,
                "HOLDINGS": 46702,
                "CIRCULATION": 145651,
                "RANKING": "-3",
                "RADIUS_KM": 2,
                "LONGITUDE": "-79.80884162931072",
                "LATITUDE": "43.24349823716794"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.80884511248826, 43.243506729946695]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 9,
                "NAME": "Locke Library",
                "BUILDING_SQ_FT": 1451,
                "HOLDINGS": 23853,
                "CIRCULATION": 92902,
                "RANKING": "-2",
                "RADIUS_KM": 1,
                "LONGITUDE": "-79.88702203808717",
                "LATITUDE": "43.25182285401401"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.88702554708998, 43.251831344928576]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 10,
                "NAME": "Mount Hope Library",
                "BUILDING_SQ_FT": 2230,
                "HOLDINGS": 15457,
                "CIRCULATION": 31195,
                "RANKING": "-1",
                "RADIUS_KM": 10,
                "LONGITUDE": "-79.91206219950452",
                "LATITUDE": "43.16057987078495"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.91206570849232, 43.160588344579814]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 11,
                "NAME": "Red Hill Library",
                "BUILDING_SQ_FT": 11760,
                "HOLDINGS": 61550,
                "CIRCULATION": 236902,
                "RANKING": "-3",
                "RADIUS_KM": 2,
                "LONGITUDE": "-79.77194471914495",
                "LATITUDE": "43.23028211377719"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.77194819008425, 43.23029060654788]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 12,
                "NAME": "Saltfleet Library",
                "BUILDING_SQ_FT": 15481,
                "HOLDINGS": 70643,
                "CIRCULATION": 252049,
                "RANKING": "-3",
                "RADIUS_KM": 2,
                "LONGITUDE": "-79.74507509332878",
                "LATITUDE": "43.22229244917222"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.74507855410857, 43.222300941414474]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 13,
                "NAME": "Sherwood Library",
                "BUILDING_SQ_FT": 20400,
                "HOLDINGS": 74754,
                "CIRCULATION": 333168,
                "RANKING": "-3",
                "RADIUS_KM": 2,
                "LONGITUDE": "-79.82861768595231",
                "LATITUDE": "43.22656912838139"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.82862117383318, 43.22657761773778]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 14,
                "NAME": "Terryberry Library",
                "BUILDING_SQ_FT": 30000,
                "HOLDINGS": 121339,
                "CIRCULATION": 590659,
                "RANKING": "-4",
                "RADIUS_KM": 5,
                "LONGITUDE": "-79.88674908217796",
                "LATITUDE": "43.23031428003548"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.88675258931161, 43.23032276676183]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 15,
                "NAME": "Valley Park Library",
                "BUILDING_SQ_FT": 3100,
                "HOLDINGS": 23668,
                "CIRCULATION": 94484,
                "RANKING": "-2",
                "RADIUS_KM": 1,
                "LONGITUDE": "-79.79790001210846",
                "LATITUDE": "43.19309594019813"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.79790348763186, 43.1931044248746]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 16,
                "NAME": "Waterdown Library",
                "BUILDING_SQ_FT": 3410,
                "HOLDINGS": 31253,
                "CIRCULATION": 143223,
                "RANKING": "-2",
                "RADIUS_KM": 2,
                "LONGITUDE": "-79.90479819381896",
                "LATITUDE": "43.32362939957626"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.90480171473268, 43.32363790226838]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 17,
                "NAME": "Westdale Library",
                "BUILDING_SQ_FT": 9950,
                "HOLDINGS": 56499,
                "CIRCULATION": 274285,
                "RANKING": "-3",
                "RADIUS_KM": 2,
                "LONGITUDE": "-79.903476765601",
                "LATITUDE": "43.262568621520266"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.9034802806002, 43.26257711368123]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 18,
                "NAME": "Stoney Creek Library",
                "BUILDING_SQ_FT": 6404,
                "HOLDINGS": 32989,
                "CIRCULATION": 87659,
                "RANKING": "-2",
                "RADIUS_KM": 2,
                "LONGITUDE": "-79.69140529595892",
                "LATITUDE": "43.21286434677112"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.69140873993837, 43.212872839683676]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 19,
                "NAME": "Turner Park Library",
                "BUILDING_SQ_FT": 23918,
                "HOLDINGS": 58400,
                "CIRCULATION": 0,
                "RANKING": null,
                "RADIUS_KM": 0,
                "LONGITUDE": "-79.87862786114596",
                "LATITUDE": "43.198467046768194"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.87863136236426, 43.19847552858239]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 20,
                "NAME": "Lynden Library",
                "BUILDING_SQ_FT": 4000,
                "HOLDINGS": 0,
                "CIRCULATION": 0,
                "RANKING": null,
                "RADIUS_KM": 0,
                "LONGITUDE": "-80.14659537003942",
                "LATITUDE": "43.23656020527914"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-80.14659895993637, 43.23656868133446]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 21,
                "NAME": "Freelton Library",
                "BUILDING_SQ_FT": null,
                "HOLDINGS": 0,
                "CIRCULATION": 0,
                "RANKING": null,
                "RADIUS_KM": 0,
                "LONGITUDE": "-80.03876645367953",
                "LATITUDE": "43.397933408491"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-80.03877002326732, 43.397941918205795]
            }
        }, {
            "type": "Feature",
            "properties": {
                "OBJECTID": 22,
                "NAME": "Greensville Library",
                "BUILDING_SQ_FT": null,
                "HOLDINGS": 0,
                "CIRCULATION": 0,
                "RANKING": null,
                "RADIUS_KM": 0,
                "LONGITUDE": "-79.99612469234015",
                "LATITUDE": "43.27528027034178"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-79.99612823790869, 43.275288760373066]
            }
        }]
};
var c = jsonObject.features;
/**
 * this function load map on page load and creates pushpins and info box on user's location
 * @returns {undefined}
 */
function loadMap() {
    map = new Microsoft.Maps.Map(document.getElementById("myMap"), {}); // Create map
    //request for user's current location
    navigator.geolocation.getCurrentPosition(function (position) {
        var loc = new Microsoft.Maps.Location(
                position.coords.latitude,
                position.coords.longitude);

        map.setView({center: loc, zoom: 10});


        //push pin and infobox for current location
        var pin = new Microsoft.Maps.Pushpin(loc, {icon: 'https://www.bingmapsportal.com/Content/images/poi_custom.png',
//          icon:"images/librarypushpin.png",
            anchor: new Microsoft.Maps.Point(12, 39)});
        infobox = new Microsoft.Maps.Infobox(loc, {title: "Current location", visible: false});
        infobox.setMap(map);
        //when we click on pin it showa infobox
        Microsoft.Maps.Events.addHandler(pin, 'click', function () {
            infobox.setOptions({visible: true});
            //                        document.getElementById("currentLocation").innerHTML = "Latitude: " + position.coords.latitude + // Set the message for user location
            //                                "<br>Longitude: " + position.coords.longitude;
            document.getElementById("user_longitude").innerHTML = position.coords.longitude;
            document.getElementById("user_latitude").innerHTML = position.coords.latitude;

        });
        //when mouse leaves the pin it hides the infobox
        Microsoft.Maps.Events.addHandler(pin, 'mouseout', function () {
            infobox.setOptions({
                visible: false});
        });

        //set the pins on the map
        map.entities.push(pin);
    },
            //
                    /**
                     * this function shows error messages when user denied to share location
                     * @param {type} e
                     * @returns {undefined}
                     */
                            function (error) {
                                var x = document.getElementById("errorMessage");
                                switch (error.code) {
                                    case error.PERMISSION_DENIED:
                                        x.innerHTML = "User denied the request for Geolocation."
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        x.innerHTML = "Location information is unavailable."
                                        break;
                                    case error.TIMEOUT:
                                        x.innerHTML = "The request to get user location timed out."
                                        break;
                                    case error.UNKNOWN_ERROR:
                                        x.innerHTML = "An unknown error occurred."
                                        break;


                                }
                            }
                    );

                    //set infobox hidden by default
                    infobox = new Microsoft.Maps.Infobox(map.getCenter(), {
                        visible: false
                    });
                    infobox.setMap(map);
                    //array for holding pins
                    libraryPins = [];
                    for (var i = 0; i < c.length; i++) {
                        var locationOfCenters = new Microsoft.Maps.Location(c[i].properties.LATITUDE, c[i].properties.LONGITUDE);
                        libraryPins[i] = new Microsoft.Maps.Pushpin(locationOfCenters,
                                null
                                );
                        libraryPins[i].metadata = {
                            title: c[i].properties.NAME,
                            description: c[i].properties.LATITUDE + "/" + c[i].properties.LONGITUDE

                        };
                        libraryPins[i].setOptions({
                            visible: false
                        });
                        // Add event handlers for clicking pins and leaving pins
                        Microsoft.Maps.Events.addHandler(libraryPins[i], 'click', pinsClicked);
                        Microsoft.Maps.Events.addHandler(libraryPins[i], 'mouseout', pinsLeave);
                        map.entities.push(libraryPins[i]);
                    }

                }

        /**
         * this function displays the metadata of pushpins when the pushpins are clicked
         * @param {type} e
         * @returns {undefined}
         */
        function pinsClicked(e) {
            if (e.target.metadata) {
                infobox.setOptions({
                    location: e.target.getLocation(),
                    title: e.target.metadata.title,
                    visible: false
                });
                document.getElementById("library_map").innerHTML = "<a href='https://bing.com/maps/default.aspx?q= " + e.target.metadata.title + "' target='_blank'>Library Map</a>";
                document.getElementById("library_name").innerHTML = e.target.metadata.title;
                var latlong = e.target.getLocation().toString();
                var lat = latlong.substring(latlong.indexOf('(')+1,latlong.indexOf(','));
                var long = latlong.substring(latlong.indexOf(',')+1,latlong.indexOf(')'));
              
                document.getElementById("long").innerHTML = long;
                document.getElementById("lat").innerHTML = lat;

            }

        }

        /**
         * this function hides infobox when mouse leaves the infobox
         * @returns {undefined}
         */
        function pinsLeave() {
            infobox.setOptions({
                visible: false
            });
        }

        /**
         * this function shows all the pushpins for libraries
         * @returns {undefined}
         */
        toggleButtonAll = 0;
        function showAllLibraries() {
            if (toggleButtonAll === 0) {
                for (var i = 0; i < c.length; i++) {
                    libraryPins[i].setOptions({
                        visible: true
                    });
                }
                toggleButtonAll = 1;
            } else {
                for (var i = 0; i < c.length; i++) {
                    libraryPins[i].setOptions({
                        visible: false
                    });
                }
                toggleButtonAll = 0;
            }

        }
